name: Hiru_eguneko_zerrenda_sortu

on:
  schedule:
    # Se ejecuta cada hora a los 20 minutos
    - cron: '20 * * * *'
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Copy scraping script
        run: |
          # Copiar el script Python al repositorio
          echo "Copiando script scrape_ipfs_events.py..."
          cat > scrape_ipfs_events.py << 'EOF'
          # [PEGAR AQU√ç TODO EL CONTENIDO DEL ARCHIVO PYTHON DE ARRIBA]
          EOF
          
          # Hacer el script ejecutable
          chmod +x scrape_ipfs_events.py

      - name: Run scraping script
        id: scrape
        run: |
          echo "=== INICIANDO SCRAPING ==="
          echo "Fecha: $(date)"
          
          # Ejecutar script y capturar salida
          python .github/scripts/Hiru_eguneko_zerrenda_sortu.py 2>&1 | tee scrape.log
          
          # Extraer estad√≠sticas del log
          EVENTS_COUNT=$(grep "Eventos encontrados:" scrape.log | tail -1 | grep -o '[0-9]*' || echo "0")
          CHANNELS_COUNT=$(grep "Canales Acestream totales:" scrape.log | tail -1 | grep -o '[0-9]*' || echo "0")
          SUCCESS=$(grep "‚úì Archivo principal creado:" scrape.log && echo "true" || echo "false")
          
          # Guardar outputs
          echo "events_count=$EVENTS_COUNT" >> $GITHUB_OUTPUT
          echo "channels_count=$CHANNELS_COUNT" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          
          echo "=== ESTAD√çSTICAS ==="
          echo "Eventos: $EVENTS_COUNT"
          echo "Canales: $CHANNELS_COUNT"
          echo "√âxito: $SUCCESS"

      - name: Show M3U file preview
        if: always()
        run: |
          echo "=== VISTA PREVIA DEL ARCHIVO M3U ==="
          if [ -f zz_eventos_ott.m3u ]; then
            echo "Tama√±o del archivo: $(wc -l < zz_eventos_ott.m3u) l√≠neas"
            echo ""
            echo "Primeras 10 l√≠neas:"
            head -12 zz_eventos_ott.m3u
            echo ""
            echo "√öltimas 5 l√≠neas:"
            tail -5 zz_eventos_ott.m3u
          else
            echo "‚ùå Archivo M3U no encontrado"
          fi
          
          echo ""
          echo "=== HIST√ìRICO ==="
          if [ -d history ]; then
            echo "Archivos en hist√≥rico: $(ls -1 history/*.m3u 2>/dev/null | wc -l || echo 0)"
            ls -1t history/*.m3u 2>/dev/null | head -3 || true
          fi

      - name: Commit and push generated files
        if: github.ref == 'refs/heads/main' && steps.scrape.outputs.success == 'true'
        run: |
          echo "=== ACTUALIZANDO REPOSITORIO ==="
          
          # Configurar git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Agregar archivos generados
          git add zz_eventos_ott.m3u history/
          
          # Verificar si hay cambios
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è No hay cambios para commitear"
          else
            # Hacer commit
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
            EVENTS=${{ steps.scrape.outputs.events_count }}
            CHANNELS=${{ steps.scrape.outputs.channels_count }}
            
            COMMIT_MSG="üì∫ Actualizaci√≥n autom√°tica de eventos ($TIMESTAMP) - $EVENTS eventos, $CHANNELS canales"
            
            git commit -m "$COMMIT_MSG"
            
            # Hacer push
            echo "Subiendo cambios al repositorio..."
            git push
            echo "‚úÖ Cambios subidos exitosamente"
          fi

      - name: Show failure details
        if: failure()
        run: |
          echo "‚ùå SCRAPING FALLIDO"
          echo ""
          echo "√öltimas 30 l√≠neas del log:"
          tail -30 scrape.log || echo "No hay archivo de log"
