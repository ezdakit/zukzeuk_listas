name: Hiru_eguneko_zerrenda_sortu

on:
  schedule:
    # Se ejecuta cada hora a los 20 minutos
    - cron: '20 * * * *'
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository with files
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0  # Traer todo el hist√≥rico

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Verify script exists
        run: |
          echo "=== VERIFICANDO ESTRUCTURA ==="
          echo "Directorio actual: $(pwd)"
          echo ""
          echo "Contenido de .github/:"
          find .github -type f -name "*.py" | sort
          echo ""
          
          SCRIPT_PATH=".github/scripts/Hiru_eguneko_zerrenda_sortu.py"
          if [ -f "$SCRIPT_PATH" ]; then
            echo "‚úÖ Script encontrado: $SCRIPT_PATH"
            echo "Tama√±o: $(wc -l < "$SCRIPT_PATH") l√≠neas"
            echo "Permisos: $(ls -l "$SCRIPT_PATH")"
          else
            echo "‚ùå ERROR: No se encuentra $SCRIPT_PATH"
            echo "Buscando scripts Python..."
            find . -name "*.py" -type f | sort
            exit 1
          fi

      - name: Run scraping script
        id: scrape
        run: |
          echo "=== INICIANDO SCRAPING DE EVENTOS ==="
          echo "Fecha y hora: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Script: .github/scripts/Hiru_eguneko_zerrenda_sortu.py"
          echo ""
          
          # Navegar al directorio ra√≠z si es necesario
          cd "$GITHUB_WORKSPACE"
          
          # Ejecutar script y capturar output
          python .github/scripts/Hiru_eguneko_zerrenda_sortu.py 2>&1 | tee scrape.log
          
          # Extraer estad√≠sticas del log
          EVENTS_COUNT=$(grep "Eventos encontrados:" scrape.log | tail -1 | grep -o '[0-9]*' || echo "0")
          CHANNELS_COUNT=$(grep "Canales Acestream totales:" scrape.log | tail -1 | grep -o '[0-9]*' || echo "0")
          
          # Determinar si fue exitoso
          if grep -q "‚úì Archivo principal creado:" scrape.log || \
             grep -q "‚úÖ Archivo principal creado:" scrape.log || \
             grep -q "Archivo principal generado:" scrape.log; then
            SUCCESS="true"
          else
            SUCCESS="false"
          fi
          
          # Tambi√©n verificar si el archivo M3U fue creado
          if [ -f "zz_eventos_ott.m3u" ]; then
            SUCCESS="true"
          fi
          
          # Guardar outputs para pasos siguientes
          echo "events_count=$EVENTS_COUNT" >> $GITHUB_OUTPUT
          echo "channels_count=$CHANNELS_COUNT" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "=== RESUMEN EJECUCI√ìN ==="
          echo "Eventos encontrados: $EVENTS_COUNT"
          echo "Canales Acestream: $CHANNELS_COUNT"
          echo "√âxito: $SUCCESS"
          echo ""
          echo "Contenido actual:"
          ls -la

      - name: Show generated files
        if: always()
        run: |
          echo "=== ARCHIVOS GENERADOS ==="
          echo "Directorio de trabajo: $(pwd)"
          echo ""
          
          # Verificar archivo M3U principal
          M3U_FILE="zz_eventos_ott.m3u"
          if [ -f "$M3U_FILE" ]; then
            LINE_COUNT=$(wc -l < "$M3U_FILE")
            echo "‚úÖ $M3U_FILE - $LINE_COUNT l√≠neas"
            
            # Contar canales reales (l√≠neas que contienen acestream:// o getstream?id=)
            STREAM_COUNT=$(grep -c "getstream?id=" "$M3U_FILE" || echo "0")
            echo "   Canales activos: $STREAM_COUNT"
            
            echo ""
            echo "üìÑ Vista previa (primeras 3 entradas completas):"
            # Mostrar entradas EXTINF + URL
            grep -A 1 "#EXTINF" "$M3U_FILE" | head -6 || true
          else
            echo "‚ùå $M3U_FILE - NO GENERADO"
            echo "Buscando archivos M3U..."
            find . -name "*.m3u" -type f | sort
          fi
          
          echo ""
          
          # Verificar hist√≥rico
          HISTORY_DIR="history"
          if [ -d "$HISTORY_DIR" ]; then
            HIST_COUNT=$(find "$HISTORY_DIR" -name "*.m3u" -type f | wc -l)
            echo "üìÇ Hist√≥rico: $HIST_COUNT archivos en $HISTORY_DIR/"
            if [ "$HIST_COUNT" -gt 0 ]; then
              echo "√öltimos 3 archivos:"
              find "$HISTORY_DIR" -name "*.m3u" -type f -printf "%T@ %p\n" | sort -rn | head -3 | cut -d' ' -f2-
            fi
          else
            echo "üìÇ Hist√≥rico: Directorio no existe"
          fi
          
          echo ""
          echo "=== TAMA√ëOS ==="
          for file in *.m3u *.json *.log 2>/dev/null; do
            if [ -f "$file" ]; then
              echo "$(du -h "$file" | cut -f1) - $file"
            fi
          done
          
          if [ -d "$HISTORY_DIR" ]; then
            echo "$(du -sh "$HISTORY_DIR" 2>/dev/null | cut -f1) - $HISTORY_DIR/"
          fi

      - name: Commit and push changes
        if: github.ref == 'refs/heads/main' && steps.scrape.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== ACTUALIZANDO REPOSITORIO ==="
          
          # Configurar git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Verificar estado
          echo "üìä Estado de git:"
          git status --porcelain || true
          
          # Agregar archivos generados (si existen)
          FILES_TO_ADD=""
          
          if [ -f "zz_eventos_ott.m3u" ]; then
            FILES_TO_ADD="$FILES_TO_ADD zz_eventos_ott.m3u"
          fi
          
          if [ -d "history" ]; then
            FILES_TO_ADD="$FILES_TO_ADD history/"
          fi
          
          if [ -f "events_debug.json" ]; then
            FILES_TO_ADD="$FILES_TO_ADD events_debug.json"
          fi
          
          if [ -n "$FILES_TO_ADD" ]; then
            echo "üì¶ Agregando archivos: $FILES_TO_ADD"
            git add $FILES_TO_ADD
            
            # Verificar si hay cambios reales
            if ! git diff --cached --quiet; then
              echo ""
              echo "üìù Cambios detectados, haciendo commit..."
              
              # Crear mensaje de commit
              TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
              EVENTS=${{ steps.scrape.outputs.events_count }}
              CHANNELS=${{ steps.scrape.outputs.channels_count }}
              
              COMMIT_MSG="üì∫ Actualizaci√≥n eventos deportivos ($TIMESTAMP)
              
‚Ä¢ Eventos: $EVENTS
‚Ä¢ Canales: $CHANNELS
‚Ä¢ Generado autom√°ticamente por GitHub Actions"
              
              # Hacer commit
              git commit -m "$COMMIT_MSG"
              
              # Hacer push
              echo "üîº Subiendo cambios a main..."
              git push origin main
              echo "‚úÖ Cambios subidos exitosamente"
            else
              echo ""
              echo "‚è≠Ô∏è  No hay cambios para commitear (contenido id√©ntico)"
            fi
          else
            echo ""
            echo "‚ö†Ô∏è  No se generaron archivos nuevos para commitear"
          fi

      - name: Show detailed logs on failure
        if: failure()
        run: |
          echo "‚ùå EL WORKFLOW HA FALLADO"
          echo "=========================================="
          echo ""
          
          echo "=== √öLTIMAS 50 L√çNEAS DEL LOG ==="
          if [ -f "scrape.log" ]; then
            tail -50 scrape.log
          else
            echo "No hay archivo scrape.log"
          fi
          
          echo ""
          echo "=== ARCHIVOS EN EL DIRECTORIO ==="
          ls -la
          
          echo ""
          echo "=== ESTRUCTURA DE .github/ ==="
          find .github -type f | sort
          
          echo ""
          echo "=== CONTENIDO DEL SCRIPT ==="
          if [ -f ".github/scripts/Hiru_eguneko_zerrenda_sortu.py" ]; then
            echo "Primeras 20 l√≠neas del script:"
            head -20 ".github/scripts/Hiru_eguneko_zerrenda_sortu.py"
          fi

      - name: Send notification on success
        if: success()
        run: |
          echo "‚úÖ SCRAPING COMPLETADO EXITOSAMENTE"
          echo ""
          echo "Resumen:"
          echo "‚Ä¢ Eventos: ${{ steps.scrape.outputs.events_count }}"
          echo "‚Ä¢ Canales: ${{ steps.scrape.outputs.channels_count }}"
          echo "‚Ä¢ √âxito: ${{ steps.scrape.outputs.success }}"
