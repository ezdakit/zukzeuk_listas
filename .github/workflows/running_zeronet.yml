name: Run ZeroNet on Ubuntu

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/running_zeronet.yml

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Establece un tiempo máximo de ejecución

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install system dependencies
        run: |
          set -e  # Detener el script si hay un error
          echo "Installing system dependencies"
          sudo apt-get update
          sudo apt-get install -y \
            wget tar curl python3 python3-pip \
            libgtk-4-1 libgraphene-1.0-0 \
            libevent-2.1-7 libopus0 libgstreamer1.0-0 libgstreamer-plugins-base1.0-0 \
            libflite1 libharfbuzz-icu0 libsecret-1-0 libhyphen0 \
            libmanette-0.2-0 libgles2
          echo "System dependencies installed"

      - name: Download and extract ZeroNet
        run: |
          set -e
          echo "Downloading ZeroNet"
          wget https://github.com/HelloZeroNet/ZeroNet-linux/archive/dist-linux64/ZeroNet-py3-linux64.tar.gz
          tar xvpfz ZeroNet-py3-linux64.tar.gz
          cd ZeroNet-linux-dist-linux64/
          echo "ZeroNet downloaded and extracted"

      - name: Start ZeroNet
        run: |
          set -e
          echo "Starting ZeroNet"
          cd ZeroNet-linux-dist-linux64/
          ./ZeroNet.sh &
          echo "ZeroNet started"

      - name: Verify ZeroNet is running
        run: |
          set -e
          echo "Verifying ZeroNet is running"
          sleep 5  # Espera 5 segundos para asegurar que ZeroNet esté listo
          curl -I http://127.0.0.1:43110
          echo "ZeroNet verification complete"

      - name: Download and analyze page content (18cZ4ehTarf34TCxntYDx9T2NHXiBvsVie)
        run: |
          set -e
          echo "Downloading http://127.0.0.1:43110/18cZ4ehTarf34TCxntYDx9T2NHXiBvsVie/"
          curl -H "Accept: text/html" -o page.html http://127.0.0.1:43110/18cZ4ehTarf34TCxntYDx9T2NHXiBvsVie/
          
          echo "Printing full HTML content:"
          cat page.html
          
          echo "Extracting JavaScript configuration:"
          CONFIG_SCRIPT=$(grep -oPz '(?s)<script id="script_init"[^>]*>.*?</script>' page.html)
          if [ -z "$CONFIG_SCRIPT" ]; then
            echo "JavaScript configuration not found."
            exit 1
          fi
          
          echo "JavaScript configuration found:"
          echo "$CONFIG_SCRIPT"
          
          ADDRESS=$(echo "$CONFIG_SCRIPT" | grep -oP 'address\s*=\s*"[^"]+"' | cut -d'"' -f2)
          WRAPPER_NONCE=$(echo "$CONFIG_SCRIPT" | grep -oP 'wrapper_nonce\s*=\s*"[^"]+"' | cut -d'"' -f2)
          WRAPPER_KEY=$(echo "$CONFIG_SCRIPT" | grep -oP 'wrapper_key\s*=\s*"[^"]+"' | cut -d'"' -f2)
          AJAX_KEY=$(echo "$CONFIG_SCRIPT" | grep -oP 'ajax_key\s*=\s*"[^"]+"' | cut -d'"' -f2)
          FILE_INNER_PATH=$(echo "$CONFIG_SCRIPT" | grep -oP 'file_inner_path\s*=\s*"[^"]+"' | cut -d'"' -f2 | sed 's/\\//g')
          SCRIPT_NONCE=$(echo "$CONFIG_SCRIPT" | grep -oP 'script_nonce\s*=\s*"[^"]+"' | cut -d'"' -f2)
          
          echo "Extracted configuration:"
          echo "Address: $ADDRESS"
          echo "Wrapper Nonce: $WRAPPER_NONCE"
          echo "Wrapper Key: $WRAPPER_KEY"
          echo "Ajax Key: $AJAX_KEY"
          echo "File Inner Path: $FILE_INNER_PATH"
          echo "Script Nonce: $SCRIPT_NONCE"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Usa una versión compatible con Playwright

      - name: Install Playwright
        run: |
          npm install playwright

      - name: Install Playwright browsers
        run: |
          npx playwright install

      - name: Extract dynamic content with Playwright
        run: |
          node extract-content.js

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ZeroNet-files
          path: |
            page.html
            final-content.html
