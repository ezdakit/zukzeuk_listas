name: Elkanoren _deskarga

on:
  schedule:
    - cron: "*/30 * * * *"   # Cada 30 minutos
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Intentar descargar desde múltiples gateways IPFS
        id: descarga
        run: |
          URLS=(
            "https://ipfs.io/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u"
            "https://k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr.ipns.dweb.link/hashes.m3u"
            "https://cloudflare-ipfs.com/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u"
            "https://hardbin.com/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u"
            "https://ipfs.runfission.com/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u"
            "https://gateway.pinata.cloud/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u"
          )

          success=false

          for url in "${URLS[@]}"; do
            echo "Intentando descargar desde: $url"

            # 3 intentos por gateway
            for i in {1..3}; do
              curl -L --max-time 20 "$url" -o elcano_tmp.m3u && break
              echo "Intento $i fallido para $url"
              sleep 5
            done

            # Si el archivo existe y no está vacío, éxito
            if [ -s elcano_tmp.m3u ]; then
              echo "Descarga correcta desde: $url"
              success=true
              break
            fi
          done

          if [ "$success" = true ]; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
          else
            echo "downloaded=false" >> $GITHUB_OUTPUT
            echo "ERROR: Ninguno de los gateways IPFS respondió correctamente"
          fi

      - name: Rotar archivos solo si la descarga fue correcta
        if: steps.descarga.outputs.downloaded == 'true'
        run: |
          if [ -f elcano_old.m3u ]; then
            rm elcano_old.m3u
          fi

          if [ -f elcano.m3u ]; then
            mv elcano.m3u elcano_old.m3u
          fi

          mv elcano_tmp.m3u elcano.m3u

      - name: Configurar Git
        if: steps.descarga.outputs.downloaded == 'true'
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Commit y push si hay cambios
        if: steps.descarga.outputs.downloaded == 'true'
        run: |
          git add elcano.m3u
          if [ -f elcano_old.m3u ]; then
            git add elcano_old.m3u
          fi

          git diff --cached --quiet || git commit -m "Actualización automática de elcano.m3u"
          git push
