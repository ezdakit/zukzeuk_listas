name: Zerrendaren_Deskarga

on:
  schedule:
    - cron: "0 * * * *"   # Cada 60 minutos
  workflow_dispatch:

permissions:
  contents: write

jobs:
  actualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Descargar elcano.m3u desde múltiples gateways IPFS
        id: elcano_descarga
        run: |
          URLS=(
            "https://ipfs.io/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u"
            "https://k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr.ipns.dweb.link/hashes.m3u"
            "https://cloudflare-ipfs.com/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u"
            "https://gateway.pinata.cloud/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u"
          )
          success=false
          for url in "${URLS[@]}"; do
            if curl -L -A "Mozilla/5.0" --max-time 20 "$url" -o elcano_tmp.m3u; then
              if [ -s elcano_tmp.m3u ] && grep -q "^#EXTM3U" elcano_tmp.m3u; then
                 success=true; break
              fi
            fi
            sleep 2
          done
          if [ "$success" != true ]; then
            echo "downloaded=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -f elcano.m3u ] && cmp -s elcano_tmp.m3u elcano.m3u; then
            echo "changed=false" >> $GITHUB_OUTPUT
            rm elcano_tmp.m3u
          else
            mv elcano_tmp.m3u elcano.m3u
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Descargar new_era.m3u desde múltiples gateways IPFS
        id: newera_descarga
        run: |
          URLS=(
            "https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004.ipns.dweb.link/data/listas/lista_iptv.m3u"
            "https://cloudflare-ipfs.com/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://gateway.pinata.cloud/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
          )
          success=false
          for url in "${URLS[@]}"; do
            if curl -L -A "Mozilla/5.0" --max-time 20 "$url" -o new_era_tmp.m3u; then
              if [ -s new_era_tmp.m3u ] && grep -q "^#EXTM3U" new_era_tmp.m3u; then
                 success=true; break
              fi
            fi
            sleep 2
          done
          if [ "$success" != true ]; then
            echo "downloaded=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -f new_era.m3u ] && cmp -s new_era_tmp.m3u new_era.m3u; then
            echo "changed=false" >> $GITHUB_OUTPUT
            rm new_era_tmp.m3u
          else
            mv new_era_tmp.m3u new_era.m3u
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Generar ezdakit.m3u fusionando listas
        id: ezdakit_generar
        run: |
          python3 << 'EOF'
          import re
          from pathlib import Path

          def parse_m3u(path_obj, source_letter):
              items = []
              if not path_obj.exists(): return items
              content = path_obj.read_text(encoding='utf-8', errors='ignore')
              lines = content.splitlines()
              
              i = 0
              while i < len(lines):
                  line = lines[i].strip()
                  if line.startswith("#EXTINF"):
                      extinf = line
                      url = None
                      j = i + 1
                      while j < len(lines):
                          next_line = lines[j].strip()
                          if next_line and not next_line.startswith("#"):
                              url = next_line
                              break
                          j += 1
                      if not url:
                          i += 1; continue

                      m_ace = re.search(r"(?:acestream://|id=|/)([0-9a-fA-F]{40})", url)
                      if m_ace:
                          ace_id = m_ace.group(1)
                          # Extraer tvg-id
                          m_id = re.search(r'tvg-id="([^"]+)"', extinf)
                          tvgid = m_id.group(1) if m_id and m_id.group(1).strip() else "Unknown"
                          
                          # Extraer nombre original (lo que va después de la última coma)
                          original_name = extinf.split(',')[-1].strip()
                          
                          # Extraer group-title
                          m_group = re.search(r'group-title="([^"]+)"', extinf)
                          group_title = m_group.group(1) if m_group else "OTROS"
                          
                          items.append((tvgid, ace_id, url, source_letter, group_title, original_name))
                      i = j 
                  i += 1
              return items

          items_elcano = parse_m3u(Path("elcano.m3u"), "E")
          items_newera = parse_m3u(Path("new_era.m3u"), "N")

          merged = {}
          for tvgid, ace, url, src, grp, ori_name in items_elcano + items_newera:
              if ace not in merged:
                  merged[ace] = (tvgid, ace, url, src, grp, ori_name)

          final_items = []
          for tvgid, ace, url, src, grp, ori_name in merged.values():
              prefix = ace[:3]
              if tvgid == "Unknown":
                  name = f"{ori_name} ({src}-{prefix})"
              else:
                  norm = tvgid[:-3] if tvgid.endswith(" HD") else tvgid
                  name = f"{norm} ({src}-{prefix})"
              
              new_extinf = f'#EXTINF:-1 tvg-id="{tvgid}" tvg-name="{name}" group-title="{grp}",{name}'
              final_items.append((tvgid if tvgid != "Unknown" else name, new_extinf, url))

          final_items.sort(key=lambda x: x[0])
          
          header = "#EXTM3U url-tvg=\"https://raw.githubusercontent.com/davidmuma/EPG_dobleM/master/guiatv.xml\" refresh=\"3600\""
          output_path = Path("ezdakit.m3u")
          new_content = header + "\n" + "\n".join([f"{ei}\n{u}" for _, ei, u in final_items])
          
          changed = True
          if output_path.exists() and output_path.read_text(encoding='utf-8') == new_content:
              changed = False
          
          if changed:
              output_path.write_text(new_content, encoding="utf-8")
              print("changed=true")
          else:
              print("changed=false")
          EOF
          echo "changed=$(python3 -c "import sys; print('true') if 'changed=true' in sys.stdin.read() else print('false')" << 'EOF'
          $(cat)
          EOF
          )" >> $GITHUB_OUTPUT

      - name: Guardar histórico y Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          mkdir -p history
          [ -f elcano.m3u ] && cp elcano.m3u "history/elcano_$(date +%F_%H-%M).m3u"
          [ -f new_era.m3u ] && cp new_era.m3u "history/new_era_$(date +%F_%H-%M).m3u"
          [ -f ezdakit.m3u ] && cp ezdakit.m3u "history/ezdakit_$(date +%F_%H-%M).m3u"
          ls -1t history/*.m3u | tail -n +151 | xargs -r rm
          git add .
          git diff --staged --quiet || (git commit -m "Update lists $(date +'%Y-%m-%d %H:%M')" && git push)
