name: zn_download_files_testing

on:
  workflow_dispatch:


env:
  ZERONET_ADDRESS_1: 18cZ4ehTarf34TCxntYDx9T2NHXiBvsVie
  ZERONET_ADDRESS_2: 1H3KoazXt2gCJgeD8673eFvQYXG7cbRddU
  OUTPUT_FOLDER: zn_downloads
  OUTPUT_FILE: eventos.html

jobs:
  download_and_process:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install system dependencies
        run: |
          echo "Instalando dependencias del sistema..."
          sudo apt-get update
          sudo apt-get install -y wget tar curl python3 python3-pip

      - name: Download and extract ZeroNet
        run: |
          echo "Descargando ZeroNet..."
          wget https://github.com/HelloZeroNet/ZeroNet-linux/archive/dist-linux64/ZeroNet-py3-linux64.tar.gz
          tar xvpfz ZeroNet-py3-linux64.tar.gz
          echo "ZeroNet descargado y extraído correctamente"

      - name: Start ZeroNet
        run: |
          echo "Iniciando ZeroNet..."
          cd ZeroNet-linux-dist-linux64/
          ./ZeroNet.sh &
          echo "Esperando 10 segundos para que ZeroNet inicie..."
          sleep 10
          echo "Verificando estado de ZeroNet..."
          curl -I http://127.0.0.1:43110 && echo "ZeroNet está funcionando"

      # Resto de tus pasos originales (descarga de archivos, generación de diffs, etc.)
      - name: Verify and create output folder
        run: |
          if [ ! -d "$OUTPUT_FOLDER" ]; then
            echo "Creando directorio de salida..."
            mkdir -p "$OUTPUT_FOLDER"
          fi

      - name: Extract dynamic content with Playwright
        run: |
          node scripts/extract-content.js "$ZERONET_ADDRESS_1" "$OUTPUT_FOLDER" "$OUTPUT_FILE"

      - name: Download lista-ott.m3u
        run: |
          echo "Descargando lista-ott.m3u..."
          curl -H "Accept: text/html" -f -o $OUTPUT_FOLDER/lista-ott.m3u http://127.0.0.1:43110/$ZERONET_ADDRESS_2/lista-ott.m3u || echo "Advertencia: No se pudo descargar lista-ott.m3u"

      # Continuar con el resto de tus pasos originales...
