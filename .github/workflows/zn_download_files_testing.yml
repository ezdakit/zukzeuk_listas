name: zn_download_files

on:
  workflow_dispatch:

env:
  ZERONET_ADDRESS_1: 18cZ4ehTarf34TCxntYDx9T2NHXiBvsVie
  ZERONET_ADDRESS_2: 1H3KoazXt2gCJgeD8673eFvQYXG7cbRddU
  OUTPUT_FOLDER: zn_downloads
  OUTPUT_FILE: eventos.html
  ZERONET_DIR: ZeroNet-linux-dist-linux64

jobs:
  setup_environment:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
        
      - name: Debug - Mostrar estructura inicial
        run: |
          echo "=== Estructura inicial del directorio ==="
          ls -la
          echo "=== Espacio disponible ==="
          df -h

      - name: Install system dependencies
        run: |
          echo "=== Instalando dependencias ==="
          sudo apt-get update
          sudo apt-get install -y wget tar curl python3 python3-pip diffutils

      - name: Download and extract ZeroNet
        run: |
          echo "=== Descargando ZeroNet ==="
          wget -q https://github.com/HelloZeroNet/ZeroNet-linux/archive/dist-linux64/ZeroNet-py3-linux64.tar.gz
          
          echo "=== Extrayendo ZeroNet ==="
          tar xvpfz ZeroNet-py3-linux64.tar.gz
          
          echo "=== Verificando extracción ==="
          echo "Contenido del directorio actual:"
          ls -la
          echo "Contenido del directorio extraído:"
          ls -la $ZERONET_DIR || echo "Probando estructura alternativa..."
          ls -la ZeroNet-linux-dist-linux64/ZeroNet-linux-dist-linux64 || true
          
          # Establecer la ruta correcta
          if [ -d "$ZERONET_DIR" ]; then
            echo "ZERONET_PATH=$GITHUB_WORKSPACE/$ZERONET_DIR" >> $GITHUB_ENV
          elif [ -d "ZeroNet-linux-dist-linux64/ZeroNet-linux-dist-linux64" ]; then
            echo "ZERONET_PATH=$GITHUB_WORKSPACE/ZeroNet-linux-dist-linux64/ZeroNet-linux-dist-linux64" >> $GITHUB_ENV
            echo "ZERONET_DIR=ZeroNet-linux-dist-linux64/ZeroNet-linux-dist-linux64" >> $GITHUB_ENV
          else
            echo "ERROR: No se pudo encontrar el directorio de ZeroNet"
            exit 1
          fi
          
          echo "Ruta establecida a: $ZERONET_PATH"

  start_zeronet:
    needs: setup_environment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Mostrar variables y estructura
        run: |
          echo "=== Variables de entorno ==="
          echo "ZERONET_PATH: $ZERONET_PATH"
          echo "ZERONET_DIR: $ZERONET_DIR"
          echo "=== Estructura del directorio ==="
          ls -la
          echo "=== Contenido de $ZERONET_DIR ==="
          ls -la $ZERONET_DIR || echo "No se puede listar el directorio"

      - name: Start ZeroNet
        run: |
          echo "=== Iniciando ZeroNet ==="
          echo "Directorio actual: $(pwd)"
          echo "Cambiando al directorio: $ZERONET_DIR"
          cd "$ZERONET_DIR" || { echo "ERROR: No se pudo cambiar al directorio $ZERONET_DIR"; exit 1; }
          
          echo "=== Contenido del directorio ZeroNet ==="
          ls -la
          
          echo "Iniciando ZeroNet en segundo plano..."
          ./ZeroNet.sh &
          ZERONET_PID=$!
          echo "ZeroNet iniciado con PID: $ZERONET_PID"
          
          echo "=== Esperando a que ZeroNet esté listo ==="
          echo "Intentando conectar a http://127.0.0.1:43110..."
          timeout 120 bash -c 'while ! curl -s -I http://127.0.0.1:43110 >/dev/null; do 
            echo "ZeroNet no responde aún, esperando 5 segundos..."
            sleep 5; 
          done'
          echo "=== ZeroNet está funcionando correctamente ==="

  # Resto del workflow (download_files, generate_diffs, process_changes) permanece igual
