name: zn_download_files_testing

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      ZERONET_ADDRESS_1: 18cZ4ehTarf34TCxntYDx9T2NHXiBvsVie
      ZERONET_ADDRESS_2: 1H3KoazXt2gCJgeD8673eFvQYXG7cbRddU
      OUTPUT_FOLDER: zn_downloads
      OUTPUT_FILE: eventos.html

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Necesario para acceder al historial completo

      - name: Create output folder
        run: mkdir -p $OUTPUT_FOLDER

      - name: Backup original files
        run: |
          # Copiar archivos actuales del repositorio
          if [ -f "$OUTPUT_FOLDER/eventos.html" ]; then
            cp "$OUTPUT_FOLDER/eventos.html" "$OUTPUT_FOLDER/eventos.html.orig"
          else
            echo "File eventos.html not found in repository" > "$OUTPUT_FOLDER/eventos.html.orig"
          fi
          
          if [ -f "$OUTPUT_FOLDER/lista-ott.m3u" ]; then
            cp "$OUTPUT_FOLDER/lista-ott.m3u" "$OUTPUT_FOLDER/lista-ott.m3u.orig"
          else
            echo "File lista-ott.m3u not found in repository" > "$OUTPUT_FOLDER/lista-ott.m3u.orig"
          fi

      # [...] (otros pasos de instalación y configuración permanecen iguales)

      - name: Generate diff files
        run: |
          echo "Generating diff files..."
          
          # Para eventos.html
          if [ -f "$OUTPUT_FOLDER/eventos.html.orig" ] && [ -f "$OUTPUT_FOLDER/eventos.html" ]; then
            echo "=== Diff for eventos.html ===" > "$OUTPUT_FOLDER/eventos.diff"
            diff -u "$OUTPUT_FOLDER/eventos.html.orig" "$OUTPUT_FOLDER/eventos.html" >> "$OUTPUT_FOLDER/eventos.diff" || echo "No differences found" >> "$OUTPUT_FOLDER/eventos.diff"
          fi
          
          # Para lista-ott.m3u
          if [ -f "$OUTPUT_FOLDER/lista-ott.m3u.orig" ] && [ -f "$OUTPUT_FOLDER/lista-ott.m3u" ]; then
            echo "=== Diff for lista-ott.m3u ===" > "$OUTPUT_FOLDER/lista-ott.diff"
            diff -u "$OUTPUT_FOLDER/lista-ott.m3u.orig" "$OUTPUT_FOLDER/lista-ott.m3u" >> "$OUTPUT_FOLDER/lista-ott.diff" || echo "No differences found" >> "$OUTPUT_FOLDER/lista-ott.diff"
          fi
          
          # Mostrar contenido de los diff para depuración
          echo "Diff contents:"
          cat "$OUTPUT_FOLDER/eventos.diff" || true
          cat "$OUTPUT_FOLDER/lista-ott.diff" || true

      # [...] (resto del workflow permanece igual)
