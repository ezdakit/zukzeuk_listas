name: zn_download_files_testing

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      ZERONET_ADDRESS_1: 18cZ4ehTarf34TCxntYDx9T2NHXiBvsVie
      ZERONET_ADDRESS_2: 1H3KoazXt2gCJgeD8673eFvQYXG7cbRddU
      ZERONET_ADDRESS_3: 13eNqJiWACUUuFM37xwUwmRiCuyMd6X2tS
      OUTPUT_FOLDER: zn_downloads
      OUTPUT_FILE: eventos.html
      OUTPUT_FILE_2: eventos_2.html

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Backup original files
        run: |
          mkdir -p $OUTPUT_FOLDER
          cp $OUTPUT_FOLDER/eventos.html $OUTPUT_FOLDER/eventos.html.orig 2>/dev/null || true
          cp $OUTPUT_FOLDER/eventos_2.html $OUTPUT_FOLDER/eventos_2.html.orig 2>/dev/null || true
          cp $OUTPUT_FOLDER/lista-ott.m3u $OUTPUT_FOLDER/lista-ott.m3u.orig 2>/dev/null || true

      - name: Install system dependencies
        run: |
          set -e
          echo "Installing system dependencies"
          sudo apt-get update
          sudo apt-get install -y wget tar curl python3 python3-pip
          echo "Dependencies installed"

      - name: Download and extract ZeroNet
        run: |
          set -e
          echo "Downloading ZeroNet"
          wget https://github.com/HelloZeroNet/ZeroNet-linux/archive/dist-linux64/ZeroNet-py3-linux64.tar.gz
          tar xvpfz ZeroNet-py3-linux64.tar.gz
          cd ZeroNet-linux-dist-linux64/
          echo "ZeroNet downloaded and extracted"

      - name: Configure ZeroNet trackers before starting
        run: |
          set -e
          echo "Configuring ZeroNet trackers..."
          cd ZeroNet-linux-dist-linux64/
          mkdir -p data logs
          mkdir -p data  # ¡Esto soluciona el error!
          cat > data/trackers_allowed.txt << 'EOF'
          zero://boot3rdez4rzn36x.onion:15441
          zero://zero.booth.moe#f36ca555bee6ba216b14d10f38c16f7769ff064e0e37d887603548cc2e64191d:15441
          udp://tracker.coppersurfer.tk:6969
          udp://tracker.leechers-paradise.org:6969
          udp://9.rarbg.com:2710
          http://tracker.opentrackr.org:1337/announce
          http://explodie.org:6969/announce
          http://tracker1.wasabii.com.tw:6969/announce
          udp://tracker.skyts.net:6969/announce
          udp://tracker.safe.moe:6969/announce
          udp://tracker.piratepublic.com:1337/announce
          udp://tracker.pirateparty.gr:6969/announce
          udp://tracker.coppersurfer.tk:6969/announce
          udp://tracker.leechers-paradise.org:6969/announce
          udp://allesanddro.de:1337/announce
          udp://9.rarbg.com:2710/announce
          http://p4p.arenabg.com:1337/announce
          udp://p4p.arenabg.com:1337/announce
          udp://tracker.opentrackr.org:1337/announce
          http://tracker.opentrackr.org:1337/announce
          udp://public.popcorn-tracker.org:6969/announce
          udp://tracker2.christianbro.pw:6969/announce
          udp://tracker1.xku.tv:6969/announce
          udp://tracker1.wasabii.com.tw:6969/announce
          udp://tracker.zer0day.to:1337/announce
          udp://tracker.mg64.net:6969/announce
          udp://peerfect.org:6969/announce
          udp://open.facedatabg.net:6969/announce
          udp://mgtracker.org:6969/announce
          http://mgtracker.org:6969/announce
          udp://explodie.org:6969/announce
          http://tracker.mg64.net:6881/announce
          http://ipv4.tracker.harry.lu:80/announce
          udp://ipv4.tracker.harry.lu:80/announce
          http://tracker1.wasabii.com.tw:6969/announce
          http://tracker.torrentyorg.pl:80/announce
          udp://zephir.monocul.us:6969/announce
          udp://z.crazyhd.com:2710/announce
          udp://tracker.vanitycore.co:6969/announce
          udp://tracker.uw0.xyz:6969/announce
          udp://tracker.tvunderground.org.ru:3218/announce
          udp://tracker.torrent.eu.org:451/announce
          udp://tracker.tiny-vps.com:6969/announce
          udp://tracker.swateam.org.uk:2710/announce
          udp://tracker.kamigami.org:2710/announce
          udp://tracker.internetwarriors.net:1337/announce
          udp://tracker.halfchub.club:6969/announce
          udp://tracker.grepler.com:6969/announce
          udp://tracker.files.fm:6969/announce
          udp://tracker.dutchtracking.com:6969/announce
          udp://tracker.doko.moe:6969/announce
          udp://tracker.dler.org:6969/announce
          udp://tracker.desu.sh:6969/announce
          udp://tracker.cypherpunks.ru:6969/announce
          udp://tracker.christianbro.pw:6969/announce
          udp://tracker.bluefrog.pw:2710/announce
          udp://tracker.acg.gg:2710/announce
          udp://thetracker.org:80/announce
          udp://santost12.xyz:6969/announce
          udp://sandrotracker.biz:1337/announce
          udp://retracker.nts.su:2710/announce
          udp://retracker.lanta-net.ru:2710/announce
          udp://oscar.reyesleon.xyz:6969/announce
          udp://open.stealth.si:80/announce
          udp://inferno.demonoid.pw:3418/announce
          udp://bt.xxx-tracker.com:2710/announce
          udp://bt.aoeex.com:8000/announce
          http://tracker.vanitycore.co:6969/announce
          http://tracker.electro-torrent.pl:80/announce
          http://tracker.devil-torrents.pl:80/announce
          http://tracker.city9x.com:2710/announce
          http://t.nyaatracker.com:80/announce
          http://retracker.telecom.by:80/announce
          http://retracker.mgts.by:80/announce
          http://pt.lax.mx:80/announce
          http://open.acgtracker.com:1096/announce
          http://fxtt.ru:80/announce
          http://agusiq-torrents.pl:6969/announce
          udp://wambo.club:1337/announce
          udp://trackerxyz.tk:1337/announce
          udp://tracker4.itzmx.com:2710/announce
          udp://tracker.xku.tv:6969/announce
          udp://tracker.justseed.it:1337/announce
          udp://tracker.cyberia.is:6969/announce
          udp://tc.animereactor.ru:8082/announce
          udp://packages.crunchbangplusplus.org:6969/announce
          udp://86.19.29.160:6969/announce
          udp://208.67.16.113:8000/announce
          http://tracker2.itzmx.com:6961/announce
          http://tracker.videodrugproject.com:80/announce
          http://tracker.tfile.me:80/announce
          http://torrentsmd.me:8080/announce
          http://share.camoe.cn:8080/announce
          http://retracker.omsk.ru:2710/announce
          http://omg.wtftrackr.pw:1337/announce
          EOF
          # Configuración para entornos restringidos
          echo '{
            "disable_udp": false,
            "offline": false,
            "trackers_file": "data/trackers_allowed.txt",
            "use_tempfiles": true
          }' > data/zeronet.conf

      - name: Start ZeroNet with forced trackers
        run: |
          cd ZeroNet-linux-dist-linux64/
          nohup ./ZeroNet.sh --debug > debug.log 2>&1 &
          
          # Espera específica para trackers UDP
          timeout 60 bash -c '
            while ! grep -q "Tracker.*udp" debug.log; do
              sleep 3
              echo -n "."
            done
          ' || echo "UDP trackers timeout"
      
      - name: Verify connections
        run: |
          cd ZeroNet-linux-dist-linux64/
          echo "=== TRACKER STATUS ==="
          grep -a "Tracker.*udp" debug.log || echo "No UDP tracker activity"
          
          echo "=== OPEN PORTS ==="
          curl -s http://127.0.0.1:43110/Stats | jq '.ip_external' || echo "No external IP"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm install playwright

      - name: Install Playwright browsers
        run: |
          npx playwright install

      - name: Check site ZERONET_ADDRESS_1 synchronization
        run: |
          echo "Checking site synchronization for $ZERONET_ADDRESS_1"
          curl -H "Accept: text/html" -I http://127.0.0.1:43110/$ZERONET_ADDRESS_1/
          echo "Site ZERONET_ADDRESS_1 synchronization checked"

      - name: Extract dynamic content with Playwright
        run: |
          node scripts/extract-content.js "$ZERONET_ADDRESS_1" "$OUTPUT_FOLDER" "$OUTPUT_FILE"

      - name: Check site ZERONET_ADDRESS_3 synchronization
        run: |
          echo "Checking site synchronization for $ZERONET_ADDRESS_3"
          curl -H "Accept: text/html" -I http://127.0.0.1:43110/$ZERONET_ADDRESS_3/
          echo "Site ZERONET_ADDRESS_3 synchronization checked"

      - name: Extract dynamic content 2 with Playwright
        run: |
          node scripts/extract-content_2.js "$ZERONET_ADDRESS_3" "$OUTPUT_FOLDER" "$OUTPUT_FILE_2"

      - name: Check site ZERONET_ADDRESS_2 synchronization
        run: |
          echo "Checking site synchronization for $ZERONET_ADDRESS_2"
          curl -H "Accept: text/html" -I http://127.0.0.1:43110/$ZERONET_ADDRESS_2/
          echo "Site ZERONET_ADDRESS_2 synchronization checked"

      - name: Download lista-ott.m3u
        run: |
          set +e
          echo "Downloading http://127.0.0.1:43110/$ZERONET_ADDRESS_2/lista-ott.m3u"
          curl -H "Accept: text/html" -f -o $OUTPUT_FOLDER/lista-ott.m3u http://127.0.0.1:43110/$ZERONET_ADDRESS_2/lista-ott.m3u
          curl_exit_code=$?
          if [ $curl_exit_code -ne 0 ]; then
            echo "Retrying download..."
            sleep 30
            curl -H "Accept: text/html" -f -o $OUTPUT_FOLDER/lista-ott.m3u http://127.0.0.1:43110/$ZERONET_ADDRESS_2/lista-ott.m3u || true
          fi
          set -e

      - name: Remove existing diff files
        run: |
          echo "Removing existing diff files"
          if [ -f "$OUTPUT_FOLDER/eventos.diff" ]; then
            rm "$OUTPUT_FOLDER/eventos.diff"
          fi
          if [ -f "$OUTPUT_FOLDER/lista-ott.diff" ]; then
            rm "$OUTPUT_FOLDER/lista-ott.diff"
          fi
          if [ -f "$OUTPUT_FOLDER/eventos_2.diff" ]; then
            rm "$OUTPUT_FOLDER/eventos_2.diff"
          fi

      - name: Generate custom diff files
        run: |
          echo "Checking eventos.html files"
          #ls -l $OUTPUT_FOLDER/eventos.html.orig
          #ls -l $OUTPUT_FOLDER/eventos.html
          if [ -f "$OUTPUT_FOLDER/eventos.html.orig" ] && [ -f "$OUTPUT_FOLDER/eventos.html" ]; then
            deleted_lines=$(grep -Fxv -f $OUTPUT_FOLDER/eventos.html $OUTPUT_FOLDER/eventos.html.orig || true)
            added_lines=$(grep -Fxv -f $OUTPUT_FOLDER/eventos.html.orig $OUTPUT_FOLDER/eventos.html || true)
            if [ -n "$deleted_lines" ] || [ -n "$added_lines" ]; then
              echo "líneas eliminadas: " > $OUTPUT_FOLDER/eventos.diff
              echo "$deleted_lines" >> $OUTPUT_FOLDER/eventos.diff
              echo -e "\n\nlíneas añadidas: " >> $OUTPUT_FOLDER/eventos.diff
              echo "$added_lines" >> $OUTPUT_FOLDER/eventos.diff
            else
              echo "No changes in eventos.html"
            fi
          else
            echo "No changes in eventos.html"
          fi
          echo "Checking eventos_2.html files"
          #ls -l $OUTPUT_FOLDER/eventos_2.html.orig
          #ls -l $OUTPUT_FOLDER/eventos_2.html
          if [ -f "$OUTPUT_FOLDER/eventos_2.html.orig" ] && [ -f "$OUTPUT_FOLDER/eventos_2.html" ]; then
            deleted_lines=$(grep -Fxv -f $OUTPUT_FOLDER/eventos_2.html $OUTPUT_FOLDER/eventos_2.html.orig || true)
            added_lines=$(grep -Fxv -f $OUTPUT_FOLDER/eventos_2.html.orig $OUTPUT_FOLDER/eventos_2.html || true)
            if [ -n "$deleted_lines" ] || [ -n "$added_lines" ]; then
              echo "líneas eliminadas: " > $OUTPUT_FOLDER/eventos_2.diff
              echo "$deleted_lines" >> $OUTPUT_FOLDER/eventos_2.diff
              echo -e "\n\nlíneas añadidas: " >> $OUTPUT_FOLDER/eventos_2.diff
              echo "$added_lines" >> $OUTPUT_FOLDER/eventos_2.diff
            else
              echo "No changes in eventos.html"
            fi
          else
            echo "No changes in eventos_2.html"
          fi
          echo "Checking lista-ott.m3u files"
          #ls -l $OUTPUT_FOLDER/lista-ott.m3u.orig
          #ls -l $OUTPUT_FOLDER/lista-ott.m3u
          if [ -f "$OUTPUT_FOLDER/lista-ott.m3u.orig" ] && [ -f "$OUTPUT_FOLDER/lista-ott.m3u" ]; then
            deleted_lines_2=$(grep -Fxv -f $OUTPUT_FOLDER/lista-ott.m3u $OUTPUT_FOLDER/lista-ott.m3u.orig || true)
            added_lines_2=$(grep -Fxv -f $OUTPUT_FOLDER/lista-ott.m3u.orig $OUTPUT_FOLDER/lista-ott.m3u || true)
            if [ -n "$deleted_lines_2" ] || [ -n "$added_lines_2" ]; then
              echo "líneas eliminadas: " > $OUTPUT_FOLDER/lista-ott.diff
              echo "$deleted_lines_2" >> $OUTPUT_FOLDER/lista-ott.diff
              echo -e "\n\nlíneas añadidas: " >> $OUTPUT_FOLDER/lista-ott.diff
              echo "$added_lines_2" >> $OUTPUT_FOLDER/lista-ott.diff
            else
              echo "No changes in lista-ott.m3u"
            fi
          else
            echo "No changes in lista-ott.m3u"
          fi

      - name: Check for file changes
        id: check_changes
        run: |
          cambios=$(git status --porcelain $OUTPUT_FOLDER)
          if [ -n "$cambios" ]; then
            echo "changes_detected=true" >> $GITHUB_ENV
            echo "Files changed:"
            echo "$cambios"
          else
            echo "changes_detected=false" >> $GITHUB_ENV
          fi

      - name: Add and commit changes
        if: env.changes_detected == 'true'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add $OUTPUT_FOLDER/
          git commit -m "Actualización automática de archivos"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger downstream workflows
        if: env.changes_detected == 'true'
        run: |
          if [ -f "$OUTPUT_FOLDER/eventos.diff" ]; then
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/dispatches \
              -d '{"event_type":"procesar_eventos"}'
          fi
          if [ -f "$OUTPUT_FOLDER/eventos_2.diff" ]; then
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/dispatches \
              -d '{"event_type":"procesar_eventos_2"}'
          fi
          if [ -f "$OUTPUT_FOLDER/lista-ott.diff" ]; then
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/dispatches \
              -d '{"event_type":"procesar_canales"}'
          fi
