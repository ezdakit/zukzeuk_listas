name: new_era_deskarga
on:

  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Intentar descargar desde múltiples gateways IPFS
        id: descarga
        run: |
          URLS=(
            "https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004.ipns.dweb.link/data/listas/lista_iptv.m3u"
            "https://cloudflare-ipfs.com/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://cf-ipfs.com/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://ipfs.runfission.com/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://gateway.pinata.cloud/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://ipfs.infura.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://ipfs.eth.aragon.network/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://ipfs.decentralized-content.com/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://ipfs.fleek.co/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://ipfs.4everland.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
            "https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u"
          )

          success=false

          for url in "${URLS[@]}"; do
            echo "Intentando descargar desde: $url"

            for i in {1..3}; do
              curl -L --max-time 20 "$url" -o new_era_tmp.m3u && break
              echo "Intento $i fallido para $url"
              sleep 5
            done

            if [ -s new_era_tmp.m3u ]; then
              echo "Descarga correcta desde: $url"
              success=true
              break
            fi
          done

          if [ "$success" = true ]; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
          else
            echo "::error title=Descarga fallida::Ninguno de los gateways IPFS respondió correctamente"
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi

      - name: Validar contenido M3U
        if: steps.descarga.outputs.downloaded == 'true'
        id: validar
        run: |
          if ! grep -q "^#EXTM3U" new_era_tmp.m3u; then
            echo "::error title=Archivo inválido::El archivo descargado NO es un M3U válido"
            echo "valid=false" >> $GITHUB_OUTPUT
          else
            echo "valid=true" >> $GITHUB_OUTPUT
          fi

      - name: Cancelar si el archivo no es válido
        if: steps.validar.outputs.valid == 'false'
        run: |
          rm new_era_tmp.m3u
          exit 0

      - name: Rotar archivos
        if: steps.validar.outputs.valid == 'true'
        run: |
          if [ -f new_era_old.m3u ]; then
            rm new_era_old.m3u
          fi

          if [ -f new_era.m3u ]; then
            mv new_era.m3u new_era_old.m3u
          fi

          mv new_era_tmp.m3u new_era.m3u

      - name: Guardar histórico (máximo 50 archivos)
        if: steps.validar.outputs.valid == 'true'
        run: |
          mkdir -p history
          timestamp=$(date +"%Y-%m-%d_%H-%M")
          cp new_era.m3u "history/new_era_$timestamp.m3u"

          # Mantener solo los últimos 50 archivos
          total=$(ls history | wc -l)
          if [ "$total" -gt 50 ]; then
            excess=$((total - 50))
            echo "Eliminando $excess archivos antiguos del histórico"
            ls -1t history | tail -n "$excess" | xargs -I {} rm "history/{}"
          fi

      - name: Configurar Git
        if: steps.validar.outputs.valid == 'true'
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Commit y push
        if: steps.validar.outputs.valid == 'true'
        run: |
          git add new_era.m3u
          git add new_era_old.m3u || true
          git add history/

          git diff --cached --quiet || git commit -m "Actualización automática de new_era.m3u"
          git push

      - name: Notificación final
        run: |
          if [ "${{ steps.validar.outputs.valid }}" = "true" ]; then
            echo "::notice title=Actualización completada::new_era.m3u actualizado correctamente"
          else
            echo "::warning title=Actualización no realizada::No se pudo actualizar new_era.m3u"
          fi
